<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Experiment Run</title>
  <link rel="stylesheet" href="./static/style.css"/>
  <script src="./stimuli_list.js"></script>
  <style>
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f5f5f5; font-family: 'Pretendard', sans-serif; }
    
    /* ê°€ë¡œ ë°°ì¹˜ë¥¼ ìœ„í•´ ì¹´ë“œ ìµœëŒ€ ë„ˆë¹„ë¥¼ 700pxë¡œ í™•ì¥ */
    .card { text-align: center; width: 95%; max-width: 700px; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    
    #progress { font-weight: 700; color: #555; margin-bottom: 20px; font-size: 1.1rem; }
    #question { margin: 25px 0; font-size: 1.4rem; color: #000; font-weight: 800; line-height: 1.4; min-height: 3.2rem; }

    button { cursor: pointer; border-radius: 8px; font-weight: 600; transition: all 0.2s; border: none; }
    .btnrow { display: flex; justify-content: center; gap: 12px; margin: 15px 0; }
    
    #playA, #playB, #playOne { background-color: #333; color: white; padding: 12px 24px; font-size: 0.9rem; }
    #playA:hover, #playB:hover, #playOne:hover { background-color: #000; }

    .choice2 { flex: 1; padding: 18px; background: white; border: 2px solid #eee; color: #000; font-size: 1.1rem; }

    /* 5AFC ê°€ë¡œ 5ì¹¸ ë°°ì¹˜ ìŠ¤íƒ€ì¼ */
    .row5 { 
      display: flex; 
      justify-content: space-between; 
      gap: 8px; 
      margin: 30px 0; 
    }
    .choice5 { 
      flex: 1; 
      display: flex; 
      flex-direction: column; /* ê¸€ìê°€ ìœ„, ì´ëª¨ì§€ê°€ ì•„ë˜ë¡œ ë°°ì¹˜ */
      align-items: center; 
      justify-content: center;
      padding: 15px 5px; 
      background: #ffffff; 
      border: 2px solid #eee;
      color: #000 !important; 
      font-size: 0.95rem; /* ê°€ë¡œ í­ì„ ìœ„í•´ í°íŠ¸ ì‚´ì§ ì¡°ì • */
      min-width: 0; /* flex ë°•ìŠ¤ ë‚´ í…ìŠ¤íŠ¸ ë„˜ì¹¨ ë°©ì§€ */
    }
    .choice5 span { font-size: 1.5rem; margin-top: 8px; } /* ì´ëª¨ì§€ í¬ê¸°ì™€ ê°„ê²© */
    .choice5:hover { background: #f9f9f9; border-color: #ccc; }

    .selected { background-color: #007bff !important; color: white !important; border-color: #007bff !important; }

    #nextBtn, #resumeBtn, #startStageBtn { background-color: #007bff; color: white; padding: 16px 40px; font-size: 1.1rem; min-width: 200px; margin-top: 10px; }
    #nextBtn:disabled { background-color: #ccc; cursor: not-allowed; }

    .hidden { display: none; }
    .panel { margin: 20px 0; }
    #breakMsg, #instructionMsg { font-size: 1.2rem; line-height: 1.6; color: #333; margin-bottom: 30px; white-space: pre-line; }
    .instr-title { color: #007bff; font-weight: bold; font-size: 1.6rem; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="card" id="app">
    <div id="progress">Loading...</div>

    <div id="instructionPanel" class="panel hidden">
        <div id="instructionTitle" class="instr-title">ì•ˆë‚´</div>
        <div id="instructionMsg"></div>
        <div class="btnrow"><button id="startStageBtn">ì‹¤í—˜ ì‹œì‘</button></div>
    </div>

    <div id="breakPanel" class="panel hidden">
        <h2 style="color: #28a745;"></h2>
        <div id="breakMsg">ì ì‹œ íœ´ì‹ì„ ì·¨í•´ì£¼ì„¸ìš”.</div>
        <div class="btnrow"><button id="resumeBtn">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button></div>
    </div>

    <h2 id="question"></h2>

    <div id="two" class="panel hidden">
      <div class="btnrow"><button id="playA">Play A</button><button id="playB">Play B</button></div>
      <div class="btnrow">
        <button class="choice2" data-choice="A">Choose A</button>
        <button class="choice2" data-choice="B">Choose B</button>
      </div>
    </div>

    <div id="one" class="panel hidden">
      <div class="btnrow"><button id="playOne">Play stimulus</button></div>
      <div class="row5">
        <button class="choice5" data-choice="amu">Amusement<span>ğŸ˜†</span></button>
        <button class="choice5" data-choice="ang">Anger<span>ğŸ’¢</span></button>
        <button class="choice5" data-choice="sad">Sadness<span>ğŸ˜¢</span></button>
        <button class="choice5" data-choice="fear">Fear<span>ğŸ˜¨</span></button>
        <button class="choice5" data-choice="surp">Surprise<span>ğŸ˜²</span></button>
      </div>
    </div>

    <div class="btnrow" id="nextRow"><button id="nextBtn" disabled>Next</button></div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbx9x0_z7qs7jfvNNeo5XWUqkZWk6c8jinpFDP_jfpfUH_VEoI2sR6YFZz42dPBd33Im/exec"; 

const NOISE_LEVELS = ["09", "12", "15"]; 

const urlParams = new URLSearchParams(window.location.search);
const participantId = urlParams.get('participant_id') || "anon";

let trials = [];
let failedTrials = []; // ğŸ”´ ì „ì†¡ ì‹¤íŒ¨í•œ ì‹œí–‰ì„ ë‹´ì•„ë‘˜ ë¦¬ìŠ¤íŠ¸
let cursor = 0;
let t0 = null;
let played = { A: [], B: [], single: [] };
let pendingChoice = null;
let currentAudio = null;
let isRetrying = false; // ì¬ì‹œë„ ëª¨ë“œì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

const emoFullNames = { "amu": "amused", "rel": "relieved", "sad": "sad", "ang": "angry", "fear": "fearful", "surp": "surprised", "sur": "surprised" };

function makeNoiseFile(dB, originalFilename) {
    return `bb_${dB}${originalFilename.replace('.wav', '')}_Norm.wav`;
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function stopAudio() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
}

function buildExperiment() {
  let s1 = [], s2 = [], s3 = [], s4 = [];
  const emotions = ["amu", "ang", "sad", "fear", "surp"];
  
  NOISE_LEVELS.forEach(dB => {
      PAIRS_DISCRIMINATION.forEach(item => {
          const swap = Math.random() < 0.5;
          s1.push({ stage: 1, block: `2I2AFC_1_${dB}dB`, stim_A: swap ? makeNoiseFile(dB, item.b) : makeNoiseFile(dB, item.a), stim_B: swap ? makeNoiseFile(dB, item.a) : makeNoiseFile(dB, item.b), t: item.t, question: `Which sounded more ${emoFullNames[item.t] || item.t}?` });
      });
      TARGETS_DRY_RVB.forEach(item => {
          const base = `${item.emo}_${item.sex}${item.utt}`;
          const swap = Math.random() < 0.5;
          s2.push({ stage: 2, block: `2I2AFC_2_${dB}dB`, stim_A: swap ? makeNoiseFile(dB, `${base}_rvb.wav`) : makeNoiseFile(dB, `${base}.wav`), stim_B: swap ? makeNoiseFile(dB, `${base}.wav`) : makeNoiseFile(dB, `${base}_rvb.wav`), emo: item.emo, question: `Which sounded more ${emoFullNames[item.emo] || item.emo}?` });
      });
      FILES_PRACTICE_5AFC.slice(0, 10).forEach(fn => { 
          const foundEmo = emotions.find(e => fn.toLowerCase().includes(e));
          s3.push({ stage: 3, block: `5AFC_practice_${dB}dB`, stim: makeNoiseFile(dB, fn), emo: foundEmo, question: "Which emotion is being expressed?" }); 
      });
      FILES_TEST_5AFC.forEach(fn => { 
          const foundEmo = emotions.find(e => fn.toLowerCase().includes(e));
          s4.push({ stage: 4, block: `5AFC_test_${dB}dB`, stim: makeNoiseFile(dB, fn), emo: foundEmo, question: "Which emotion is being expressed?" }); 
      });
  });

  const intro2AFC = { type: 'instruction', msg: "Listen to two sounds (A and B) in order, then choose the best answer." };
  const intro5AFC = { type: 'instruction', msg: "Listen to the sound and choose one of the five emotions. To listen again, click 'Play stimulus'." };

  shuffle(s4);
  let s4_parts = [];
  const size = 45;
  for (let i = 0; i < s4.length; i += size) {
      let sub = s4.slice(i, i + size);
      let subNum = (i / size) + 1;
      sub.forEach((t, idx) => { t.display_stage = `4-${subNum}`; t.trial_in_sub = idx + 1; t.total_in_sub = sub.length;  });
      s4_parts.push(...sub);
      if (i + size < s4.length) s4_parts.push({ type: 'break' });
  }

  [s1, s2, s3].forEach((stageArr, i) => {
      shuffle(stageArr);
      stageArr.forEach((t, idx) => { t.display_stage = (i + 1).toString(); t.trial_in_sub = idx + 1; t.total_in_sub = stageArr.length; });
  });

  return [intro2AFC, ...s1, {type: 'break'}, ...s2, {type: 'break'}, intro5AFC, ...s3, {type: 'break'}, ...s4_parts];
}

function loadTrial() {
  stopAudio();

  // ğŸ”´ [ì¤‘ìš”] ëª¨ë“  ì‹œí–‰ì´ ëë‚¬ì„ ë•Œ ì‹¤íŒ¨í•œ ê²Œ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§
  if (cursor >= trials.length) { 
      if (failedTrials.length > 0) {
          // ì‹¤íŒ¨í•œ ëª©ë¡ì´ ìˆë‹¤ë©´
          alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì €ì¥ë˜ì§€ ì•Šì€ ${failedTrials.length}ê°œì˜ ì‹œí–‰ì´ ìˆìŠµë‹ˆë‹¤.\ní™•ì¸ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ ì‹œí–‰ë“¤ì„ ë‹¤ì‹œ ì§„í–‰í•©ë‹ˆë‹¤.`);
          
          // trialsë¥¼ ì‹¤íŒ¨í•œ ê²ƒë“¤ë¡œë§Œ êµì²´
          trials = [...failedTrials];
          failedTrials = []; // ì‹¤íŒ¨ ëª©ë¡ ì´ˆê¸°í™” (ë‹¤ì‹œ í•˜ë‹¤ê°€ ë˜ ì‹¤íŒ¨í•˜ë©´ ì—¬ê¸°ì— ë‹¤ì‹œ ìŒ“ì„)
          cursor = 0;
          isRetrying = true; // ì¬ì‹œë„ ì¤‘ì„ì„ í‘œì‹œ
          loadTrial(); // ë‹¤ì‹œ ì‹œì‘
          return;
      } else {
          // ì‹¤íŒ¨í•œ ê²ƒë„ ì—†ê³  ë‹¤ ëë‚¬ìœ¼ë©´ ì¢…ë£Œ í˜ì´ì§€ë¡œ
          window.location.href = "./done.html"; 
          return; 
      }
  }

  const t = trials[cursor];
  played = { A: [], B: [], single: [] }; pendingChoice = null; t0 = performance.now();
  document.querySelectorAll(".panel").forEach(p => p.classList.add("hidden"));
  document.getElementById("nextRow").classList.add("hidden");

  if (t.type === 'break' || t.type === 'instruction') {
      document.getElementById("progress").textContent = t.type === 'break' ? "Break" : "Instruction";
      document.getElementById("question").textContent = "";
      if (t.type === 'break') document.getElementById("breakPanel").classList.remove("hidden");
      else { document.getElementById("instructionMsg").textContent = t.msg; document.getElementById("instructionPanel").classList.remove("hidden"); }
      return;
  }
  document.getElementById("nextRow").classList.remove("hidden");
  document.getElementById("nextBtn").disabled = true;
  document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
  
  // ì§„í–‰ ìƒí™© í‘œì‹œ (ì¬ì‹œë„ ì¤‘ì¼ ë•ŒëŠ” ë³„ë„ í‘œì‹œ)
  let progressText = `Stage ${t.display_stage} (Trial ${t.trial_in_sub} / ${t.total_in_sub})`;
  if (isRetrying) progressText += " [ì¬ì‹œë„ ì¤‘]";
  
  document.getElementById("progress").textContent = progressText;
  document.getElementById("question").textContent = t.question;
  document.getElementById(t.stim_A ? "two" : "one").classList.remove("hidden");
  if (!t.stim_A) setTimeout(() => playAudio('single'), 500);
}

function playAudio(type) {
  stopAudio();
  const t = trials[cursor];
  let folder = t.stage <= 2 ? "EMO_PRACT_rvb_Norm_final" : (t.stage === 3 ? "EMO_137_Norm_final" : "EMO_STIM_rvb_Norm_final");
  let file = (type === 'A') ? t.stim_A : (type === 'B' ? t.stim_B : t.stim);
  currentAudio = new Audio(`./stimuli/${folder}/${file}`);
  currentAudio.play();
  played[type].push(Math.round(performance.now() - t0));
}

document.getElementById("resumeBtn").onclick = () => { cursor++; loadTrial(); };
document.getElementById("startStageBtn").onclick = () => { cursor++; loadTrial(); };
document.getElementById("playA").onclick = () => playAudio('A');
document.getElementById("playB").onclick = () => playAudio('B');
document.getElementById("playOne").onclick = () => playAudio('single');

document.querySelectorAll(".choice2, .choice5").forEach(btn => {
  btn.onclick = () => {
    btn.closest('.panel').querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    pendingChoice = btn.dataset.choice;
    document.getElementById("nextBtn").disabled = false;
  };
});

document.getElementById("nextBtn").onclick = () => {
  stopAudio();
  const t = trials[cursor]; // í˜„ì¬ ì‹œí–‰ ì •ë³´ë¥¼ ë°±ì—…í•´ë‘  (ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
  
  const noiseMatch = t.block.match(/(\d+)(?=dB)/);
  const dbValue = noiseMatch ? noiseMatch[0] : "";

  let finalResponse = pendingChoice; 
  let stimType = ""; 
  let isCorrect = null;

  const targetValue = t.t || t.emo || ""; 

  if (t.stage === 1) {
    const selectedFile = (pendingChoice === 'A') ? t.stim_A : t.stim_B;
    const emotions = ["amu", "ang", "sad", "fear", "surp", "rel"];
    finalResponse = emotions.find(e => selectedFile.includes(e)) || pendingChoice;
    isCorrect = selectedFile.includes(t.t) ? 1 : 0;
    stimType = "dry";
  } 
  else if (t.stage === 2) {
    const selectedFile = (pendingChoice === 'A') ? t.stim_A : t.stim_B;
    finalResponse = selectedFile.includes('rvb') ? 'rvb' : 'dry';
    stimType = finalResponse;
    isCorrect = null;
  } 
  else if (t.stage === 3 || t.stage === 4) {
    if (t.stim && t.stim.includes('rvb1')) stimType = 'rvb1';
    else if (t.stim && t.stim.includes('rvb2')) stimType = 'rvb2';
    else if (t.stim && t.stim.includes('rvb')) stimType = 'rvb';
    else stimType = 'dry';

    finalResponse = pendingChoice; 
    isCorrect = (pendingChoice === targetValue) ? 1 : 0;
  }

  const payload = {
    participant_id: participantId, 
    // ì¬ì‹œë„ì¸ ê²½ìš° ì›ë˜ ë¡œê·¸ì— í‘œì‹œë¥¼ ë‚¨ê¸¸ ìˆ˜ë„ ìˆìŒ
    block: t.block + (isRetrying ? "_RETRY" : ""),
    noise_db: dbValue,
    question: t.question, 
    stim_A: t.stim_A || "", 
    stim_B: t.stim_B || "", 
    stim: t.stim || "",
    target: targetValue,
    response: finalResponse,
    stim_type: stimType, 
    is_correct: isCorrect,
    rt_ms: Math.round(performance.now() - t0), 
    played_log: JSON.stringify(played)
  };

  // ğŸ”´ [ìˆ˜ì •ë¨] ê¸°ë‹¤ë¦¬ì§€ ì•Šê³ (no await) ë³´ë‚´ë˜, ì‹¤íŒ¨í•˜ë©´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
  fetch(GAS_URL, { 
      method: "POST", 
      mode: "no-cors", 
      body: JSON.stringify(payload) 
  })
  .then(() => {
      // ì„±ê³µ ì‹œ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (ì˜ ê°”ê² ê±°ë‹ˆ í•¨)
      // no-cors ëª¨ë“œë¼ ì„œë²„ ë‚´ë¶€ ì—ëŸ¬ëŠ” ëª» ì¡ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ëŠ” catchë¡œ ì¡í˜
  })
  .catch((err) => {
      console.error("ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨! ì¬ì‹œë„ ëª©ë¡ì— ì¶”ê°€:", err);
      // ì‹¤íŒ¨í•œ í˜„ì¬ ì‹œí–‰(t)ì„ ì¬ì‹œë„ ë¦¬ìŠ¤íŠ¸ì— ë„£ìŒ
      failedTrials.push(t);
  });

  // ì¦‰ì‹œ ë‹¤ìŒìœ¼ë¡œ ì´ë™ (ì†ë„ ì €í•˜ ì—†ìŒ)
  cursor++; 
  loadTrial();
};

window.onload = () => { trials = buildExperiment(); loadTrial(); };
</script>
</body>
</html>
